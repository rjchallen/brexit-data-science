<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="common.css">
</head>
<body>

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="common.js"></script>
	<script src="lib/d3pie.min.js"></script>

	<div id="table"></div>
	<div id="pieChart"></div>

	<script>

	function componentToHex(c) {
	    var hex = Math.floor(c).toString(16);
	    return hex.length == 1 ? "0" + hex : hex;
	}

	function rgbToHex(r, g, b) {
	    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
	}
 
d3.tsv("data/poll.tsv", function(error, data) {
	  if (error) throw error;
	  
	var byQ1 = d3.nest()
		.key(function(d) {return d.q1;})
		.sortKeys(d3.ascending)
		.rollup(function(vals) {
			var frac = vals.length / data.length;
			var sd = Math.sqrt((frac*(1-frac))/data.length);
			return {
				label: vals[0].q1_label, 
				size: vals.length,
				percent: frac * 100,
				confidence: (1.96*sd+0.5/data.length)*100
			};
		})
		.entries(data);

	console.log(byQ1); 

	var table = d3.select("#table")
		.append("table");
	table.append("caption").text("The advantages to the UK of access to the EU free market outweigh any disadvantages of the free movement of workers across the EU.");
	var th = table.append('thead').append("tr");
	th.append("th").text("response");
	th.append("th").text("count (n="+data.length+")");
	th.append("th").text("percent (+/- 95% confidence)");
	
	var tr = table.append('tbody').selectAll("tr")
		.data(byQ1)
 		.enter()
		.append("tr");
	
	var td = tr.selectAll("td")
	  .data( function(d) { 
		  return [
	      	d.value.label,
	      	d.value.size,
	      	d.value.percent.toFixed(1)+"% (+/- "+d.value.confidence.toFixed(1)+"%)"
	                               ];})
	  .enter().append("td")
	  .text(function(d) {return d})
	  
	var c = -1;
	var content = byQ1.map(function(d) {c++; return {
		"item":c,
		  "label":d.value.label,
	      "count":d.value.size,
	      "color":rgbToHex(255/4*c, 255/4*(4-c), 128)
	  }});
	  
	console.log(content);
	
	var width = 500;
    var height = 400;
    var radius = Math.min(width, height) / 2;
    
    var legendRectSize = 18;
    var legendSpacing = 4;
    
    var svg = d3.select('#pieChart')
      .append('svg')
      .attr('width', width+200)
      .attr('height', height)
      .append('g')
      .attr('transform', 'translate(' + (width / 2) + 
        ',' + (height / 2) + ')');

    var arc = d3.arc()
    	.innerRadius(0)
      .outerRadius(radius);

    var pie = d3.pie()
      .value(function(d) { return d.count; })
      .sort(null);

    var path = svg.selectAll('path')
      .data(pie(content))
      .enter()
      .append('path')
      .attr('d', arc)
      .attr('fill', function(d, i) { 
        return d.data.color;
      })
       .style('stroke', '#ffffff');;
	
    var legend = svg.selectAll('.legend')
    .data(content)
    .enter()
    .append('g')
    .attr('class', 'legend')
    .attr('transform', function(d) {return 'translate('+(width-200+legendRectSize)+','+(d.item*(legendRectSize+legendSpacing)-(height / 2))+')'});
       
    legend.append('rect')
    .attr('width', legendRectSize)
    .attr('height', legendRectSize)
    .style('fill', function(d) {return d.color;})
    .style('stroke', function(d) {return d.color;});
    
    legend.append('text')
    .attr('x', legendRectSize + legendSpacing)
    .attr('y', legendRectSize - legendSpacing)
    .text(function(d) { return d.label; });
    
});
		</script>




</body>
</html>